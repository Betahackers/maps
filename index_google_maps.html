<!DOCTYPE html>
<html>
<head>
	<title>Betachallenge</title>
	<meta charset="utf-8">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=true"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="data3.json"></script>
</head>
<body>
<div id="map" style="width: 800px; height: 800px; float:left;"></div>
<div id="sidebar" style="width: 150px; height: 800px; background-color:#DADAD8; float:left;">
<svg id="timeline">
<!-- 	<line x1="25" y1="25" x2="25" y2="200" stroke="red" stroke-width="3" />
	<line x1="25" y1="200" x2="25" y2="300" stroke="red" stroke-width="3" stroke-dasharray="5,5"/>
	<line x1="25" y1="300" x2="25" y2="475" stroke="red" stroke-width="3" />
	<line x1="25" y1="475" x2="25" y2="600" stroke="red" stroke-width="3" />

	<circle cx="25" cy="25" r="10" stroke="#EDEDED" stroke-width="6" fill="red" />
	<circle cx="25" cy="200" r="10" stroke="#EDEDED" stroke-width="6" fill="red" />
	<circle cx="25" cy="300" r="10" stroke="#EDEDED" stroke-width="6" fill="red" />
	<circle cx="25" cy="475" r="10" stroke="#EDEDED" stroke-width="6" fill="red" />
	<circle cx="25" cy="600" r="10" stroke="#EDEDED" stroke-width="6" fill="red" /> -->
</svg>
</div>
<script>
$(document).ready(function(){

	var container = document.getElementById('map');

	var map = new google.maps.Map(container, {
		zoom: 14,
		center: new google.maps.LatLng(41.3897, 2.1699),
		mapTypeId: google.maps.MapTypeId.ROADMAP,
		mapTypeControl: false,
	    streetViewControl: false
	});

	var colors = new Array();
	var color_number = 0;
	colors[0] = "#FF0000";
	colors[1] = "#00FF00";
	colors[2] = "#0000FF";
	colors[3] = "#FFFF00";


	map.set('styles', [
	{
		featureType: 'road',
		elementType: 'labels',
		stylers: [
		{ visibility: 'off' }
		]
	},
	{
		featureType: 'road',
		elementType: 'geometry',
		stylers: [
		{ color: "#FFFFFF" }
		]
	},
	{
		featureType: 'road.highway',
		elementType: 'geometry',
		stylers: [
		{ color: "#FFFFFF" },
		{saturation: -100}
		]
	},
	{
		featureType: 'road.arterial',
		elementType: 'geometry',
		stylers: [
		{ color: "#FFFFFF" },
		{saturation: -100},
		{lightness: 30},
		]
	},
	{
		featureType: "road.local",
		stylers: [
			{saturation: -100},
			{lightness: 40},
		]
	},
	{
		featureType: 'transit',
		elementType: 'geometry',
		stylers: [
		{ visibility: 'off' }
		]
	},
	{
		featureType: 'transit',
		elementType: 'labels',
		stylers: [
		{ visibility: 'off' }
		]
	},
	{
		featureType: 'poi',
		elementType: 'labels',
		stylers: [
		{ visibility: 'off' }
		]
	},
	{
		featureType: 'poi',
		elementType: 'geometry',
		stylers: [
		{ visibility: 'off' }
		]
	},
	{
		featureType: "landscape",
		stylers: [
			{saturation: -100},
			{lightness: 65},
			{visibility: 'on'}
		]
	},
	{
	featureType: "administrative",
	elementType: "labels",
	stylers: [
		{hue: "#ffff00"},
		{saturation: -50},
		{lightness: 60},
	]
	},
	{
		featureType: "water",
		elementType: "geometry",
		stylers: [
			{hue: "#ffff33"},
			{saturation: -97}
		]
	},
	{
		featureType: "water",
		elementType: "labels",
		stylers: [
			{visibility: 'off'}
		]
	}
	]);

	var infowindow = new google.maps.InfoWindow();

	var path;

	// var articles = articles.article;
	var bounds = new google.maps.LatLngBounds();
	for (var i = 0; i < articles[0].article.length; i++) {
		var article = articles[0].article[i];
		drawItinary(article, colors[i]);
	}

	// Draw the timeline in the sidebar
	drawTimeLine();

	function drawItinary(article, color){

		var mapLocations = article.locations;

		if(mapLocations.length == 0){
			return;
		}

		var positions = [];

		for (var i = 0; i < mapLocations.length; i++) {

			var mapLocation = mapLocations[i];
			// console.log(mapLocation);

			mapLocation.html = '';
			mapLocation.html += '<b>' + mapLocation.name + '</b><br>';
			mapLocation.html += 'Itinary: ' + article.title + '<br>';

			var pos = new google.maps.LatLng(mapLocation.latitude, mapLocation.longitude);
			var props = {
				position: pos,
				map: map,
				icon: {
					path: google.maps.SymbolPath.CIRCLE,
					strokeColor: '#DDD9D5',
					strokeOpacity: 1,
					scale: 8
				}
			};
			positions.push(pos);
			// console.log(mapLocation);


			// var pinColor = mapLocation.color;
			// var iconUrl = "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=" + mapLocation.num;
			// if (mapLocation.color){
			// 	iconUrl += "|" + pinColor;
			// }
			// props.icon = new google.maps.MarkerImage(iconUrl,
			// 	new google.maps.Size(21, 34),
			// 	new google.maps.Point(0,0),
			// 	new google.maps.Point(10, 34));
			// props.shadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
			// 	new google.maps.Size(40, 37),
			// 	new google.maps.Point(0, 0),
			// 	new google.maps.Point(12, 35));

			mapLocation.marker = new google.maps.Marker(props);
			google.maps.event.addListener(mapLocation.marker, 'click', (function(marker, i) {
				return function() {
					showMapLocation(marker, i);
					// infowindow.setContent(mapLocation.html);
					// infowindow.open(map, marker);
				}
			})(mapLocation.marker, i));
			// console.log(mapLocation);

			bounds.extend(mapLocation.marker.position);

		}

		if (mapLocations.length > 0) {
			map.fitBounds(bounds);
		}

		var path = new google.maps.Polyline({
			path: positions,
			geodesic: true,
			strokeColor: color,
			strokeColor: colors[color_number],
			strokeOpacity: 1.0,
			strokeWeight: 2
		});
		color_number = (color_number + 1) % 4;

		google.maps.event.addListener(path, 'click', (function(path) {
			return function() {
				alert("Hi");
				//showMapLocation(marker, i);
				// infowindow.setContent(mapLocation.html);
				// infowindow.open(map, marker);
			}
		})(path));

		path.setMap(map);

		//drawItinaryLines(positions);

		function showMapLocation(marker, i){
			infowindow.setContent(mapLocations[i].html);
			infowindow.open(map, marker);
		}

	}

	function drawItinaryLines (positions) {

		var newPositions = [];

		for (var i = 0; i < positions.length - 1; i++) {
			var current = positions[i];
			var next = positions[i+1];

			var heading = google.maps.geometry.spherical.computeHeading(current, next);
			//console.log(heading);
			//console.log(45 * Math.round(heading / 45));

			var dLng = next.lng() - current.lng();
			var dLat = next.lat() - current.lat();

			if (Math.abs(dLng) > Math.abs(dLat)) {
				newPositions.push(current);
				newPositions.push(new google.maps.LatLng(current.lat(), next.lng()-dLat/2));
				newPositions.push(new google.maps.LatLng(current.lat()+dLat/2, next.lng()));
				newPositions.push(new google.maps.LatLng(next.lat(), next.lng()));
				newPositions.push(next);
			} else {
				newPositions.push(current);
				newPositions.push(new google.maps.LatLng(current.lat(), next.lng()-dLng/2));
				newPositions.push(new google.maps.LatLng(current.lat()+dLat/2, next.lng()));
				newPositions.push(new google.maps.LatLng(next.lat(), next.lng()));
				newPositions.push(next);
			}

			// if( midLng != current.lng() && midLng != next.lng() ) {
			// 	newPositions.push(current);
			// 	newPositions.push(new google.maps.LatLng(current.lat(), midLng));
			// 	newPositions.push(new google.maps.LatLng(next.lat(), midLng));
			// 	newPositions.push(next);
			// }
		};

		path = new google.maps.Polyline({
			path: newPositions,
			geodesic: true,
			//strokeColor: color[2],
			strokeColor: "#FFFF00",
			strokeOpacity: 1.0,
			strokeWeight: 2
		});

		path.setMap(map);

		google.maps.event.addListener(path, 'click', function() {
			alert('ok');
			console.log('Bounds changed.');
		});

	}

	function drawTimeLine () {
		drawMetroLine(25, 200);
		drawWalkLine(200, 300);
		drawMetroLine(300, 475);
		drawMetroLine(475, 600);

		drawLocation(25);
		drawLocation(200);
		drawLocation(300);
		drawLocation(475);
		drawLocation(600);
	}
	function drawLocation (y) {
		d3.select("#timeline")
			.append("circle")
			.attr("cx", 25)
			.attr("cy", y)
			.attr("r", 10)
			.attr("stroke", "#EDEDED")
			.attr("stroke-width", "6")
			.attr("fill", "red");
	}

	function drawMetroLine (y1, y2) {
		d3.select("#timeline")
			.append("line")
			.attr("x1", 25)
			.attr("y1", y1)
			.attr("x2", 25)
			.attr("y2", y2)
			.attr("stroke", "red")
			.attr("stroke-width", "3");
	}

	function drawWalkLine (y1, y2) {
		d3.select("#timeline")
			.append("line")
			.attr("x1", 25)
			.attr("y1", y1)
			.attr("x2", 25)
			.attr("y2", y2)
			.attr("stroke", "red")
			.attr("stroke-width", "3")
			.attr("stroke-dasharray","5,5");
	}
});
</script>
</body>
</html>
